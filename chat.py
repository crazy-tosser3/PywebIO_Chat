from pywebio import start_server
from pywebio.input import *
from pywebio.output import *
from pywebio.session import *

import asyncio
import json
import os

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞ –∏ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
chat_msgs = []
online_users = set()
muted_users = set()  # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –∑–∞–ø—Ä–µ—â–µ–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
admins = {
    "–õ—ã–∫–æ–≤": "52472862",

    "–ê–ª–µ–π–Ω–∏–∫–æ–≤" : "GG25SGAG37G6O7DD8G9HDWE",
    "–ê–ª–µ–π–Ω–∏–∫–æ–≤ –†–æ–º–∞" : "GG25SGAG37G6O7DD8G9HDWE",
    "–ê–ª–µ–π–Ω–∏–∫–æ–≤ –†–æ–º–∞–Ω" : "GG25SGAG37G6O7DD8G9HDWE",
    "–†–æ–º–∞ –ê–ª–µ–π–Ω–∏–∫–æ–≤" : "GG25SGAG37G6O7DD8G9HDWE",
    "–†–æ–º–∞–Ω –ê–ª–µ–π–Ω–∏–∫–æ–≤" : "GG25SGAG37G6O7DD8G9HDWE",
    "Forest" : "GG25SGAG37G6O7DD8G9HDWE",
    
    "–ò–ª—å—á–µ–Ω–∫–æ" : "1452",
    "–ù–∞—Å—Ç–∞–≤–Ω–∏–∫" : "PKTi03"
}  # –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ —Å –∏—Ö –ø–∞—Ä–æ–ª—è–º–∏

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–æ–ª–µ–π –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
participants = {
    "mentor": "mentorpass"  # –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ —Å –ø–∞—Ä–æ–ª–µ–º
}

MAX_MSG_COUNT = 100  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã —á–∞—Ç –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–ª—Å—è
MSG_FILE = "chat_history.json"  # –ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞
def load_messages():
    global chat_msgs
    if os.path.exists(MSG_FILE):
        with open(MSG_FILE, 'r', encoding='utf-8') as f:
            chat_msgs = json.load(f)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
def save_messages():
    global chat_msgs
    with open(MSG_FILE, 'w', encoding='utf-8') as f:
        json.dump(chat_msgs, f)

# –ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
async def admin_actions(nicname, msg_box):
    global chat_msgs
    while True:
        # –í—ã–≤–æ–¥–∏–º –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π —Å –≤—ã–±–æ—Ä–æ–º –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        action = await actions('‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', buttons=['–ú—å—é—Ç/–†–∞–∑–º—å—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', '–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç', '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ', '–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å'])

        # –î–µ–π—Å—Ç–≤–∏–µ –º—å—é—Ç/—Ä–∞–∑–º—å—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if action == '–ú—å—é—Ç/–†–∞–∑–º—å—é—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è':
            target_user = await input("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –º—å—é—Ç–∞/—Ä–∞–∑–º—å—é—Ç–∞", required=True)
            if target_user in online_users:
                if target_user in muted_users:
                    muted_users.remove(target_user)  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–º—å—é—á–µ–Ω, —Ä–∞–∑–º—å—é—Ç–∏–º
                    chat_msgs.append(('üéÉ', f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `{target_user}` —Ä–∞–∑–º—å—é—á–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
                    msg_box.append(put_markdown(f"üéÉ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `{target_user}` —Ä–∞–∑–º—å—é—á–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
                else:
                    muted_users.add(target_user)  # –ò–Ω–∞—á–µ –º—å—é—Ç–∏–º
                    chat_msgs.append(('üéÉ', f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `{target_user}` –∑–∞–º—å—é—á–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
                    msg_box.append(put_markdown(f"üéÉ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å `{target_user}` –∑–∞–º—å—é—á–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
            else:
                toast("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!", color="error")

        # –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
        elif action == '–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç':
            chat_msgs.clear()  # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            msg_box.reset()  # –û—á–∏—â–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            chat_msgs.append(('üéÉ', f"–ß–∞—Ç –±—ã–ª –æ—á–∏—â–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
            msg_box.append(put_markdown(f"üéÉ –ß–∞—Ç –±—ã–ª –æ—á–∏—â–µ–Ω –∞–¥–º–∏–Ω–æ–º `{nicname}`!"))
            save_messages()  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è

        # –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –µ–≥–æ –∏–Ω–¥–µ–∫—Å—É
        elif action == '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ':
            target_idx = await input("–í–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–Ω–∞—á–∏–Ω–∞—è —Å 0)", type=NUMBER, required=True)
            if 0 <= target_idx < len(chat_msgs):
                deleted_msg = chat_msgs.pop(target_idx)
                msg_box.clear()  # –û–±–Ω–æ–≤–ª—è–µ–º —á–∞—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                for m in chat_msgs:
                    msg_box.append(put_markdown(f"`{m[0]}`: {m[1]}"))
                toast(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç `{deleted_msg[0]}` —É–¥–∞–ª–µ–Ω–æ!", color="success")
            else:
                toast("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å —Å–æ–æ–±—â–µ–Ω–∏—è!", color="error")

        elif action == '–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å':
            break

    save_messages()

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞
async def main():
    global chat_msgs

    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —á–∞—Ç
    put_markdown('üìö –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π –≥—Ä—É–ø–ø–æ–π –ò–°–ü9-kh11!!!')

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ —á–∞—Ç –±—ã–ª —É–∂–µ –∑–∞–ø—É—â–µ–Ω —Ä–∞–Ω–µ–µ)
    load_messages()

    # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
    msg_box = output()

    # –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    put_scrollable(msg_box, height=300, keep_bottom=True)

    # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_exit = False
    last_nicname = None

    while True:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —á–∞—Ç–∞, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–∑–∞–π—Ç–∏ —Å —Ç–µ–º –∂–µ –Ω–∏–∫–æ–º
        if user_exit:
            action = await actions('–í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞. –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?', buttons=['–ü–µ—Ä–µ–∑–∞–π—Ç–∏', '–ó–∞–∫—Ä—ã—Ç—å'])
            if action == '–ü–µ—Ä–µ–∑–∞–π—Ç–∏':
                nicname = last_nicname  # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—à–ª–æ–µ –∏–º—è
                user_exit = False
            else:
                break
        else:
            # –ü—Ä–æ—Å–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ –æ–Ω
            nicname = await input("–í–æ–π–¥–∏—Ç–µ –≤ —á–∞—Ç", required=True, placeholder="–í–∞—à–µ –∏–º—è", 
                                  validate=lambda n: "–≠—Ç–æ –∏–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ" if n in online_users or n == 'üéÉ' else None)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–∞
            if nicname in participants:
                participant_password = await input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –ù–∞—Å—Ç–∞–≤–Ω–∏–∫–∞", type=PASSWORD, required=True)
                if participant_password == participants[nicname]:
                    # –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –∫–∞–∫ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–Ω–ª–∞–π–Ω
                    online_users.add(nicname)
                else:
                    toast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!", color="error")
                    continue

            # –ï—Å–ª–∏ –Ω–µ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞
            is_admin = False
            if nicname in admins:
                admin_password = await input("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–¥–º–∏–Ω–∞", type=PASSWORD, required=True)
                if admin_password == admins[nicname]:
                    is_admin = True
                    nicname = f"[–ê–¥–º–∏–Ω] {nicname}"  # –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∞–¥–º–∏–Ω–∞
                else:
                    toast("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!", color="error")
                    continue

            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω
            online_users.add(nicname)

            # –°–æ–æ–±—â–∞–µ–º –≤—Å–µ–º, —á—Ç–æ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
            chat_msgs.append(('üéÉ', f"{nicname} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –±–µ—Å–µ–¥–µ!"))
            msg_box.append(put_markdown(f'`{nicname}` –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –±–µ—Å–µ–¥–µ!'))

            # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–¥–∞—á—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            refresh_task = run_async(refresh_msg(nicname, msg_box))

            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ—à–ª—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
            for m in chat_msgs:
                msg_box.append(put_markdown(f"`{m[0]}`: {m[1]}"))

            # –ï—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–¥–º–∏–Ω—Å–∫—É—é –ø–∞–Ω–µ–ª—å
            if is_admin:
                run_async(admin_actions(nicname, msg_box))
                put_buttons(['–û—Ç–∫—Ä—ã—Ç—å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å'], onclick=lambda _: run_async(admin_actions(nicname, msg_box)))

            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –¥–ª—è –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            while True:
                # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                data = await input_group('‚úâ –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ', [
                    input(placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è", name="msg"), 
                    actions(name="cmd", buttons=["–û—Ç–ø—Ä–∞–≤–∏—Ç—å", {'label': "–í—ã–π—Ç–∏ –∏–∑ —á–∞—Ç–∞", 'type': "cancel"}])
                ])

                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª
                if data is None:
                    user_exit = True
                    last_nicname = nicname
                    break

                # –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if data['cmd'] == "–û—Ç–ø—Ä–∞–≤–∏—Ç—å":
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
                    if not data['msg']:
                        toast("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!", color="error")
                        continue

                    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—å—é—á–µ–Ω, –æ–Ω –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if nicname in muted_users:
                        toast("–í—ã –∑–∞–º—å—é—á–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è!", color="error")
                        continue

                    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
                    msg_box.append(put_markdown(f"`{nicname}`: {data['msg']}"))
                    chat_msgs.append((nicname, data['msg']))

                    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    save_messages()

            # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            refresh_task.close()

            # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω
            online_users.remove(nicname)

            # –°–æ–æ–±—â–∞–µ–º –≤—Å–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç
            toast("–í—ã –≤—ã—à–ª–∏ –∏–∑ —á–∞—Ç–∞!")
            msg_box.append(put_markdown(f"üéÉ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {nicname} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç!"))
            chat_msgs.append(('üéÉ', f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {nicname} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç!"))

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            save_messages()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ
async def refresh_msg(nickname, msg_box):
    global chat_msgs
    last_idx = len(chat_msgs)  # –ò–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–æ–µ –≤–∏–¥–µ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

    while True:
        await asyncio.sleep(1)  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

        # –í—ã–≤–æ–¥–∏–º –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        for m in chat_msgs[last_idx:]:
            if m[0] != nickname:  # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                msg_box.append(put_markdown(f"`{m[0]}`: {m[1]}"))

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
        if len(chat_msgs) > MAX_MSG_COUNT:
            chat_msgs = chat_msgs[len(chat_msgs) // 2:]

        last_idx = len(chat_msgs)  # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

# –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ PyWebIO
if __name__ == '__main__':
    start_server(main, debug=True, port=8080, cdn=False)
